apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: object-store
  name: object-store
  namespace: REPLACE_NAMESPACE
  annotations:
    # SECURITY NOTE: This MinIO deployment is used ONLY for local development
    # and CI subsystem testing. Production deployments use cloud-native S3
    # storage (AWS S3, etc.) and do not deploy this component.
    assisted-service.io/deployment-type: "test-infrastructure"
spec:
  replicas: 1
  selector:
    matchLabels:
      app: object-store
  template:
    metadata:
      labels:
        app: object-store
    spec:
      # ============================================================================
      # SECURITY CONTEXT DOCUMENTATION
      # ============================================================================
      # MinIO (quay.io/minio/minio) is designed to run as root (UID 0).
      # We cannot enforce runAsNonRoot: true because:
      #   1. Without explicit runAsUser: MinIO defaults to root, causing
      #      "container has runAsNonRoot and image will run as root" error
      #   2. With explicit runAsUser (e.g., 1000): OpenShift SCC rejects it
      #      because the UID is not in the namespace's allowed range
      #
      # MITIGATIONS IN PLACE:
      #   - privileged: false - container cannot gain additional privileges
      #   - allowPrivilegeEscalation: false - prevents privilege escalation attacks
      #   - capabilities: drop ALL - removes all Linux capabilities
      #   - seccompProfile: RuntimeDefault - applies default seccomp filtering
      #   - hostNetwork/hostPID/hostIPC: false - no host namespace access
      #
      # SCOPE: This deployment is TEST INFRASTRUCTURE ONLY (local dev, CI tests).
      # Production assisted-service uses cloud S3 storage, not local MinIO.
      # ============================================================================
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      # Host namespace restrictions
      hostNetwork: false
      hostPID: false
      hostIPC: false
      containers:
        - image: quay.io/minio/minio:latest
          name: s3server
          securityContext:
            # MinIO requires root - see security documentation above
            privileged: false
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
          args:
            - server
            - /data
          env:
            - name: MINIO_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: assisted-installer-s3
                  key: aws_secret_access_key
            - name: MINIO_ROOT_USER
              valueFrom:
                secretKeyRef:
                  name: assisted-installer-s3
                  key: aws_access_key_id
          volumeMounts:
            - mountPath: /data
              name: data
          resources:
            limits:
              cpu: 500m
              memory: 2000Mi
            requests:
              cpu: 300m
              memory: 2000Mi
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: object-store
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app: object-store
  name: object-store
  namespace: REPLACE_NAMESPACE
spec:
  ports:
    - name: object-store
      port: 9000
      protocol: TCP
      targetPort: 9000
  selector:
    app: object-store
  type: LoadBalancer
status:
  loadBalancer: {}
