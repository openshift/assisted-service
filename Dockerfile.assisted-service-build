FROM registry.access.redhat.com/ubi9/go-toolset:1.24 AS golang

RUN curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/main/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.64.8
RUN go install gotest.tools/gotestsum@v1.12.3

FROM quay.io/centos/centos:stream9 AS centos-packages

ENV GOROOT=/usr/lib/golang
ENV GOPATH=/opt/app-root/src/go
ENV VIRTUAL_ENV=/opt/venv
# A directory in the path with write permission even for non-root users
ENV TOOLS=/tools/
ENV PATH="$VIRTUAL_ENV/bin:$GOROOT/bin:$GOPATH/bin:$TOOLS:$PATH"

COPY --from=golang $GOPATH $GOPATH
COPY --from=golang $GOROOT $GOROOT

RUN chmod 775 -R $GOPATH && chmod 775 -R $GOROOT

RUN dnf install -y --enablerepo=crb \
        openssl openssl-devel postgresql nmstate-devel sqlite gcc genisoimage git libvirt-client libvirt-devel java make numactl-libs && \
    dnf clean all

RUN git config --system --add safe.directory '*'

WORKDIR /home/assisted-service
RUN mkdir -p build $TOOLS && chmod g+xw build $TOOLS
COPY ./hack/setup_env.sh ./dev-requirements.txt ./
RUN ./setup_env.sh podman_remote && \
    ./setup_env.sh assisted_service && \
    chmod g+xw -R $GOPATH

FROM registry.access.redhat.com/ubi9/ubi-minimal:latest@sha256:6fc28bcb6776e387d7a35a2056d9d2b985dc4e26031e98a2bd35a7137cd6fd71

ENV GOROOT=/usr/lib/golang
ENV GOPATH=/opt/app-root/src/go
ENV VIRTUAL_ENV=/opt/venv

ENV TOOLS=/tools/
ENV PATH="$VIRTUAL_ENV/bin:$GOROOT/bin:$GOPATH/bin:$TOOLS:$PATH"

COPY --from=golang $GOPATH $GOPATH
COPY --from=golang $GOROOT $GOROOT
RUN chmod 775 -R $GOPATH && chmod 775 -R $GOROOT

# TODO: Replace with version 0.30.4 once it is released.
#
# We need version 5d0a00d of go-swagger because it is the first that contains
# the change that we need in order to be able to reject unknown JSON fields.
# That will eventually be part of release 0.30.4, but that doesn't exist yet.
#
# For details see the pull request where that capability was added:
#
# https://github.com/go-swagger/go-swagger/pull/2863
#
# And the ticket:
#
# https://issues.redhat.com/browse/MGMT-12697
COPY --from=quay.io/goswagger/swagger:sha-5d0a00d /usr/bin/swagger /usr/bin/goswagger

COPY --from=quay.io/edge-infrastructure/swagger-codegen-cli:2.4.18 /opt/swagger-codegen-cli /opt/swagger-codegen-cli
COPY --from=quay.io/openshift/origin-cli:latest /usr/bin/oc /usr/bin
COPY --from=quay.io/operator-framework/upstream-opm-builder:v1.16.1 /bin/opm /bin
COPY --from=registry.k8s.io/kustomize/kustomize:v5.7.1 /app/kustomize /usr/bin/

COPY --from=centos-packages /usr/bin/gcc /usr/bin/make /usr/bin/java /usr/bin/git /usr/bin/sqlite3 /usr/bin/
COPY --from=centos-packages /usr/bin/genisoimage /usr/bin/virsh /usr/bin/
COPY --from=centos-packages /usr/local/bin /usr/local/bin
COPY --from=centos-packages /home/assisted-service/build /home/assisted-service/build
COPY --from=centos-packages $TOOLS $TOOLS

COPY --from=centos-packages /usr/lib64/libssl.so* /usr/lib64/libcrypto.so* /usr/lib64/
COPY --from=centos-packages /usr/lib64/libpq.so* /usr/lib64/libsqlite3.so* /usr/lib64/
COPY --from=centos-packages /usr/lib64/libvirt*.so* /usr/lib64/libnmstate*.so* /usr/lib64/
COPY --from=centos-packages /usr/lib64/libisoburn.so* /usr/lib64/libburn.so* /usr/lib64/libisofs.so* /usr/lib64/
COPY --from=centos-packages /usr/lib64/libnl*.so* /usr/lib64/libnuma*.so* /usr/lib64/

RUN microdnf install -y tar gzip && microdnf clean all

# Git checks if the user that owns the files on the filesystem match the
# current user.  We need to disable this check because tests in Prow are
# running with a random user.
RUN git config --system --add safe.directory '*'

WORKDIR /home/assisted-service
COPY ./data /tmp/data
