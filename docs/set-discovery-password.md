# Setting a password for the discovery ISO

The discovery ISO generated by the Assisted Installer comes with a `core` user
that has its password login disabled (although SSH access using the provided
public key is still supported).

However, it can sometimes be useful (e.g. when SSH isn't working), to login to
the machine directly (with physical or BMC access), using a password. This can
be done using the console login prompt that is shown after the ISO boots up.

To allow that, the user must have a password set. In order to set a password,
it's possible to use the following script which allows editing the discovery
ISO's ignition file core user with a password

# Change ISO `core` user password script

The following script takes the path of the downloaded discovery ISO file as its
first argument, prompts the user to enter a password, and creates a similarly
named ISO file in the same folder as the original one but with password login
enabled.

```bash
#!/bin/bash

set -euo pipefail

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 <path to discovery .iso>"
    exit 1
fi

if [[ ! -f $1 ]]; then
    echo "ERROR: Discovery ISO not found at $1"
    exit 1
fi

DISCOVERY_ISO_HOST_PATH="$1"
DISCOVERY_ISO_HOST_DIR=$(dirname "$DISCOVERY_ISO_HOST_PATH")
function COREOS_INSTALLER() {
    podman run -v "$DISCOVERY_ISO_HOST_DIR":/data --rm quay.io/coreos/coreos-installer:release "$@"
}

ISO_NAME=$(basename "$DISCOVERY_ISO_HOST_PATH" .iso)

# Container paths
DISCOVERY_ISO_PATH=/data/${ISO_NAME}.iso
DISCOVERY_ISO_WITH_PASSWORD=/data/${ISO_NAME}_with_password.iso

# Host output path
DISCOVERY_ISO_WITH_PASSWORD_HOST=$(dirname "$DISCOVERY_ISO_HOST_PATH")/$(basename "$DISCOVERY_ISO_WITH_PASSWORD")

# Prompt
read -sp 'Please enter the password to be used by the "core" user: ' pw
echo ''
USER_PASSWORD=$(openssl passwd -6 --stdin <<< $pw)
unset pw

# Transform original ignition
TRANSFORMED_IGNITION_PATH=$(mktemp --tmpdir="$DISCOVERY_ISO_HOST_DIR")
TRANSFORMED_IGNITION_NAME=$(basename "$TRANSFORMED_IGNITION_PATH")
COREOS_INSTALLER iso ignition show "$DISCOVERY_ISO_PATH" | jq --arg pass "$USER_PASSWORD" '.passwd.users[0].passwordHash = $pass' > "$TRANSFORMED_IGNITION_PATH"

if [[ -f "$DISCOVERY_ISO_WITH_PASSWORD_HOST" ]] ; then
    echo "ERROR: $DISCOVERY_ISO_WITH_PASSWORD_HOST already exists"
    echo "Would you like to overwrite it? [y/N]"
    read -r SHOULD_OVERWRITE
    if [[ "$SHOULD_OVERWRITE" != "y" ]]; then
        echo "Exiting"
        exit 1
    fi
fi

# Generate new ISO
rm -f "$DISCOVERY_ISO_WITH_PASSWORD_HOST"
COREOS_INSTALLER iso customize --output "$DISCOVERY_ISO_WITH_PASSWORD" --force "$DISCOVERY_ISO_PATH" --live-ignition /data/"$TRANSFORMED_IGNITION_NAME"
echo 'Created ISO with your password in "'"$DISCOVERY_ISO_WITH_PASSWORD_HOST"'", the login username is "core"'
```
