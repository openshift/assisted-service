---
title: easy-discovery-password
authors:
  - "@omertuc"
creation-date: 2022-08-02
last-updated: 2022-08-02
---

# Easy discovery login password

Give users an easy, safe way to set the discovery ISO ignition

## Summary

We want to improve the UI to allow the user to set the `core` user password for
the discovery ISO so they can easily login to their cluster and troublehshoot
networking issues, in the absence of a working SSH connection to the server.

In addition, we should improve the API and documnetation to make it possible
for users to set an ignition `core` user password without having to deal with
complicated ignition overrides.

## Motivation

The discovery ISO generated by the Assisted Installer comes with a `core` user
that has its password login disabled (although SSH access using the provided
public key is still supported).

However, it can sometimes be useful (e.g. when the network is misbehaving, SSH
isn't working, and you want to troubleshoot why), to login to the machine
directly (with physical or through server remote management solutions), using a
password. This can be done using the console login prompt that is shown after
RHCOS is done booting.

To allow that, the user must have a password set. In order to set a password,
it's possible to use the Assisted Installer ignition override API which
provides support for editing the discovery ISO's ignition file with custom
parameters.

This method is complicated and should be made easier.

### Goals

- Add new UI to set the `core` user password for the discovery ISO 
- Add new API to set the ignition password hash for the discovery ISO `core`
user password, with documentation explaining how it can be done
- Do all of that in a secure way. At no point should the service know the
user's password. But it's okay if the service knows the hash, as that doesn't
reveal the password

### Non-Goals

- Allow the core user password to be set even after the host has been
discovered. We could technically create a new agent step that would set the
discovery password hash to whatever the user wants on a live system, but that
would be useless in 99% of cases since if the networking is working well enough
for the agent to connect to the service, it's probably working well enough for
the user to SSH into the server using their public key anyway - no password
needed.

## Proposal

### New service APIs

#### REST API

- Add a new optional `discovery_core_user_password_hash` parameter to the
`infra-env-create-params` API structure. Ensure this parameter has
`description:` documentation explaining how the hash can be calculated and what
its format should look like, preferably with an example. The service will use
this new parameter to set the `core` user discovery ISO password hash. Since
this is just a salted hash, the service has no practical way to figure out what
the password actually is.

#### Kubernetes API

- Extend the InfraEnv CR to support a similar (see REST API section above)
`discovery_core_user_password_hash` parameter.

### UI changes

- Extend the discovery ISO generation UI modal to let users input a password.
If and when the user provides a password in that field, UI will calculate the
hash for the user-provided password and will set the `discovery_core_user_password_hash`
parameter accordingly.

### User Stories

#### Story 1 - UI

As a cluster administrator using the Assisted Installer to install a cluster, I
want to use the UI to safely generate the discovery ISO with a password set for
the `core` user, so I can log into my server while it's running the discovery
ISO without using SSH, as I'm having issues with my server networking.

#### Story 2 - API

As a cluster administrator using the Assisted Installer to install a cluster, I
want to use the API to safely generate the discovery ISO with a password set
for the `core` user, so I can log into my server while it's running the
discovery ISO without using SSH, as I'm having issues with my server
networking.

### Implementation Details/Notes/Constraints

#### Generating the hash in the UI is hard

The hash has to be generated in a particular way. On a regular Linux machine,
this can easily be done with the `mkpasswd --method=SHA-512 <password>`
command, but obviously the UI can't run arbitrary Linux commands - we would
have to re-implement this logic and cryptographic functions in JavaScript
(emulate the UNIX `crypt` POSIX C lib function - randomize the salt, calculate
the hash on the password), or perhaps port the `mkpasswd` utility to WASM.

Of course we should first look into existing solutions that may have already
done something similar. When I checked almost two years ago I didn't find
anything promising, but maybe things have changed or I missed something.

### Risks and Mitigations

#### Additional attack surface

By setting a password, the user adds yet another way to authenticate to their
hosts during their discovery phase, and that's trivially less secure than
having less ways to authenticate.

Users could possibly set very weak / obvious passwords, which would allow
someone with physical or remote-management access to the machine to interact
with it.

This is not a big deal because:

- This only affects the discovery phase for the host. Once the host gets
installed and reboots into OCP the password login can no longer be used

- People with physical or remote-management access can probably do a lot
of bad things anyway even without entering the password

#### The user still has to trust the UI

The user puts their trust in the UI that it won't transmit their raw password
to the service. This is not a big deal because the user already puts a lot of
trust in us installing the cluster on their servers. We can assure the users
that their password is kept safe with a UI note - or alternatively, give them
an alternative UI to paste the hash of the password directly, instead of the
password itself, so they can be 100% confident that we don't know it.

## Design Details [optional]

None

### Open Questions

None

### UI Impact

Already addressed, the UI is one of the main parts of this enhancement.

### Test Plan

Standard testing requirements.

## Drawbacks

- Complexity - UI hash implementation could be difficult
- Doesn't allow the user to set the password *after* the host has already
booted, required re-generating the ISO and booting the host again. See
non-goals for why this is not a big deal.

## Alternatives

- Don't do anything, keep telling users to use ignition overrides for this
purpose.
